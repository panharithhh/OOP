<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIGHTBITE - Find Your Spot</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-dark': '#1c1c1c',
            'brand-dark-secondary': '#2a2a2a',
            'brand-light': '#F5F5F5',
            'brand-accent': '#FF5722',
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #2a2a2a; }
    ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
    #map { min-height: calc(100vh - 24px); }
  </style>
</head>
<body class="bg-brand-dark text-brand-light">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-brand-dark-secondary p-6 sticky top-0 h-screen overflow-y-auto hidden lg:block">
      <h1 class="text-3xl font-extrabold text-white tracking-wider mb-10">NIGHTBITE</h1>

      <div class="space-y-8">
        <!-- Search -->
        <div>
          <form method="POST" action="/search" class="w-full">
            <div class="relative">
              <input type="text" name="search_term" placeholder="Search restaurants..." class="w-full px-4 py-2 pl-10 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-accent focus:border-transparent text-white"/>
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              </div>
            </div>
          </form>
        </div>

        <!-- Filter by Price -->
        <div>
          <h3 class="font-bold text-lg mb-3 text-gray-300">Filter by Price</h3>
          <form method="POST" action="/filter-restaurants" class="space-y-3">
            <div class="flex flex-col space-y-2">
              <button type="submit" name="price_range" value="1" class="w-full text-left px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors">$</button>
              <button type="submit" name="price_range" value="2" class="w-full text-left px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors">$$</button>
              <button type="submit" name="price_range" value="3" class="w-full text-left px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors">$$$</button>
              <button type="submit" name="price_range" value="4" class="w-full text-left px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors">$$$$</button>
            </div>
          </form>
        </div>

        <!-- Filter by Tag -->
        <div>
          <h3 class="font-bold text-lg mb-3 text-gray-300">Filter by Tag</h3>
          <form method="POST" action="/filter-by-tag" class="grid grid-cols-2 gap-2">
            {% for t in available_tags %}
              {% set cnt = tag_counts[t]|default(0) %}
              <button
                type="submit"
                name="tag"
                value="{{ t }}"
                class="flex items-center justify-between px-3 py-2 rounded-md border border-gray-700 bg-gray-700 transition-colors
                       {% if active_tag and t|lower == active_tag|lower %}!bg-brand-accent text-white border-brand-accent{% else %}hover:bg-brand-accent hover:text-white{% endif %}
                       {% if cnt == 0 %} opacity-50 cursor-not-allowed{% endif %}"
                {% if cnt == 0 %}disabled{% endif %}
                title="{{ t|capitalize }}"
              >
                <span>{{ t|capitalize }}</span>
                <span class="text-xs px-2 py-0.5 rounded bg-gray-800 border border-gray-600">{{ cnt }}</span>
              </button>
            {% endfor %}
          </form>
        </div>

        <!-- Sort By -->
        <div>
          <h3 class="font-bold text-lg mb-3 text-gray-300">Sort by</h3>
          <div class="space-y-2">
            <a
              href="/userdash?sort=ratings{% if selected_price is not none %}&price_range={{ selected_price }}{% endif %}{% if active_tag %}&tag={{ active_tag|urlencode }}{% endif %}"
              class="block px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors"
            >Highest Rated</a>
            <a href="#" id="sort-distance" class="block px-4 py-2 rounded-md bg-gray-700 hover:bg-brand-accent hover:text-white transition-colors">Distance</a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-3 md:p-6 w-full">
      <div class="mb-4 lg:hidden">
        <form method="POST" action="/search" class="w-full">
          <div class="relative">
            <input type="text" name="search_term" placeholder="Search restaurants..." class="w-full px-4 py-2 pl-10 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-accent focus:border-transparent text-white"/>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
          </div>
        </form>
      </div>

      <!-- Nearest banner -->
      <div id="nearest-banner" class="hidden mb-4 px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-sm"></div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- List -->
        <section class="xl:col-span-2">
          <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if restaurant_client_data %}
              {% for restaurant in restaurant_client_data %}
                {% set rating = restaurant.ratings|default(0)|float %}
                {% set lat = restaurant.latitude|default(None) %}
                {% set lng = restaurant.longitude|default(None) %}
                {% set pic = restaurant.picture.image_path if restaurant.picture and restaurant.picture.image_path else '' %}
                {% set rawpic = pic | replace('\\','/') %}
                <div class="bg-brand-dark-secondary rounded-lg shadow-lg overflow-hidden hover:ring-2 hover:ring-brand-accent transition"
                     data-id="{{ restaurant.id }}"
                     data-rating="{{ '%.3f'|format(rating) }}"
                     data-lat="{{ lat if lat is not none else '' }}"
                     data-lng="{{ lng if lng is not none else '' }}">
                  <button class="w-full text-left" onclick="focusOn({{ restaurant.id }})">
                    <div class="h-44 bg-gray-800 flex items-center justify-center">
                      {% if rawpic %}
                        <img src="{{ rawpic }}" alt="{{ restaurant.name }}" class="w-full h-full object-cover"/>
                      {% else %}
                        <div class="text-gray-500 p-6">
                          <svg class="h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                      {% endif %}
                    </div>
                  </button>
                  <div class="p-4">
                    <div class="flex justify-between items-start gap-3">
                      <h3 class="text-xl font-bold text-white">{{ restaurant.name }}</h3>
                      <div class="flex items-center whitespace-nowrap">
                        <span class="text-yellow-400">
                          {% for i in range(5) %}{% if i < (rating|int) %}★{% else %}☆{% endif %}{% endfor %}
                        </span>
                        <span class="ml-1 text-sm text-gray-400">{{ "%.1f"|format(rating) }}</span>
                      </div>
                    </div>

                    <p class="mt-2 text-gray-400">{{ restaurant.description|default('')|truncate(100) }}</p>

                    <div class="mt-3 flex items-center flex-wrap gap-2">
                      <span class="text-brand-accent font-medium">{{ '$' * (restaurant.price_range|default(1, true)|int) }}</span>
                      {% if restaurant.tag %}<span class="px-2 py-1 bg-gray-700 text-xs text-gray-300 rounded-full">{{ restaurant.tag|capitalize }}</span>{% endif %}
                      {% if restaurant.distance_km is defined and restaurant.distance_km is not none %}
                        <span class="ml-auto text-sm text-gray-300">{{ "%.2f"|format(restaurant.distance_km) }} km</span>
                      {% else %}
                        <span class="ml-auto text-sm text-gray-300 js-distance hidden"></span>
                      {% endif %}
                    </div>

                    <div class="mt-4 flex items-center justify-between">
                      <a href="/details/{{ restaurant.id }}" class="inline-flex items-center text-sm font-medium text-brand-accent hover:text-white">
                        View details
                        <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                      </a>
                      <button class="text-xs text-gray-400 hover:text-white" onclick="focusOn({{ restaurant.id }})">Center on map</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="col-span-full text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <h3 class="mt-2 text-lg font-medium text-white">No restaurants found</h3>
                <p class="mt-1 text-gray-400">Try adjusting your search or filter criteria</p>
              </div>
            {% endif %}
          </div>
        </section>

        <!-- Map -->
        <aside class="xl:col-span-1">
          <div id="map" class="rounded-xl overflow-hidden sticky top-3"></div>
        </aside>
      </div>
    </main>
  </div>

  <!-- ONE-TIME location request with cache -->
  <script>
    const LOC_KEY = "nb_user_loc";
    const MAX_LOC_AGE_MS = 30 * 60 * 1000; // 30 mins

    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = (v) => (v * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function saveLoc(lat, lng) {
      try { localStorage.setItem(LOC_KEY, JSON.stringify({ lat, lng, ts: Date.now() })); } catch {}
    }
    function loadLoc() {
      try {
        const raw = localStorage.getItem(LOC_KEY);
        if (!raw) return null;
        const o = JSON.parse(raw);
        if (!o || typeof o.lat !== "number" || typeof o.lng !== "number" || typeof o.ts !== "number") return null;
        if (Date.now() - o.ts > MAX_LOC_AGE_MS) return null;
        return o;
      } catch { return null; }
    }
    function getLocationOnce(cb) {
      const cached = loadLoc();
      if (cached) { cb(cached.lat, cached.lng, true); return; }
      if (!navigator.geolocation) { cb(null, null, false); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => { const {latitude: lat, longitude: lng} = pos.coords; saveLoc(lat, lng); cb(lat, lng, false); },
        () => cb(null, null, false),
        { enableHighAccuracy: true, timeout: 6000, maximumAge: 300000 }
      );
    }

    const map = L.map('map', { zoomControl: true });
    const defaultCenter = [11.5564, 104.9282]; // Phnom Penh
    map.setView(defaultCenter, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    const markersById = new Map();
    const bounds = [];
    function addMarker(cardEl) {
      const id = cardEl.dataset.id;
      const lat = parseFloat(cardEl.dataset.lat);
      const lng = parseFloat(cardEl.dataset.lng);
      const name = cardEl.querySelector('h3')?.textContent?.trim() || 'Unknown';
      if (!isFinite(lat) || !isFinite(lng)) return;
      const m = L.marker([lat, lng]).addTo(map);
      const details = cardEl.querySelector('a[href^="/details/"]')?.getAttribute('href') || '#';
      const rating = parseFloat(cardEl.dataset.rating || '0').toFixed(1);
      m.bindPopup(`<div style="min-width:180px"><strong>${name}</strong><br/>⭐ ${rating}<br/><a href="${details}">View details</a></div>`);
      markersById.set(id, m);
      bounds.push([lat, lng]);
    }
    function buildMarkers() {
      markersById.clear(); bounds.length = 0;
      document.querySelectorAll('#cards > div[data-id]').forEach(addMarker);
      if (bounds.length) { try { map.fitBounds(bounds, { padding: [30, 30] }); } catch(e) {} }
      setTimeout(() => map.invalidateSize(), 200);
    }
    function focusOn(id) {
      const m = markersById.get(String(id));
      if (!m) return;
      const ll = m.getLatLng();
      map.flyTo(ll, Math.max(map.getZoom(), 16), { duration: 0.6 });
      m.openPopup();
    }
    window.focusOn = focusOn;

    function updateDistanceLabels(lat, lng) {
      document.querySelectorAll('#cards > div[data-id]').forEach(card => {
        const rlat = parseFloat(card.dataset.lat);
        const rlng = parseFloat(card.dataset.lng);
        if (isFinite(rlat) && isFinite(rlng)) {
          const d = haversine(lat, lng, rlat, rlng);
          const slot = card.querySelector('.js-distance');
          if (slot) { slot.textContent = `${d.toFixed(2)} km`; slot.classList.remove('hidden'); }
        }
      });
    }

    function plotYouAndNearestCached() {
      getLocationOnce((lat, lng) => {
        if (lat == null || lng == null) return;
        L.circleMarker([lat, lng], { radius: 8, color: 'red', fillColor: 'red', fillOpacity: 0.9 }).addTo(map).bindPopup('You are here').openPopup();
        updateDistanceLabels(lat, lng);
        let nearest = null;
        document.querySelectorAll('#cards > div[data-id]').forEach(card => {
          const rlat = parseFloat(card.dataset.lat);
          const rlng = parseFloat(card.dataset.lng);
          if (!isFinite(rlat) || !isFinite(rlng)) return;
          const d = haversine(lat, lng, rlat, rlng);
          if (!nearest || d < nearest.d) nearest = { id: card.dataset.id, name: card.querySelector('h3')?.textContent?.trim() || 'Unknown', lat: rlat, lng: rlng, d, card };
        });
        if (nearest) {
          const m = markersById.get(String(nearest.id));
          if (m) { m.bindPopup(`${nearest.name} — ${nearest.d.toFixed(2)} km`).openPopup(); }
          const banner = document.getElementById('nearest-banner');
          if (banner) { banner.innerHTML = `Nearest: <strong>${nearest.name}</strong> — ${nearest.d.toFixed(2)} km`; banner.classList.remove('hidden'); }
          nearest.card?.classList.add('ring-2','ring-brand-accent');
        }
      });
    }

    document.getElementById('sort-distance')?.addEventListener('click', (e) => {
      e.preventDefault();
      const price = "{{ selected_price is not none and selected_price or '' }}";
      const tag   = "{{ active_tag|urlencode if active_tag else '' }}";
      getLocationOnce((lat, lng) => {
        if (lat == null || lng == null) { alert('Please allow location to sort by distance.'); return; }
        const url = `/userdash?sort=distance&user_lat=${lat}&user_lng=${lng}`
          + (price ? `&price_range=${price}` : '')
          + (tag ? `&tag=${tag}` : '');
        window.location.href = url;
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      buildMarkers();
      const serverLat = {{ user_lat if user_lat is defined and user_lat is not none else 'null' }};
      const serverLng = {{ user_lng if user_lng is defined and user_lng is not none else 'null' }};
      if (isFinite(serverLat) && isFinite(serverLng)) saveLoc(serverLat, serverLng);
      plotYouAndNearestCached();
    });
  </script>
</body>
</html>